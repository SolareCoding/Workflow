import * as React from 'react';
import { useEffect } from 'react';
import WorkflowView from "../workflow/Workflow.view";
import { UpdateMode } from "./WorkPanel.controller";
const defaultController = {
    plugin: undefined,
    updatePipeline(pipeline) { },
    updateSection(pipeline, section) { },
    updateNode(pipeline, section, node) { },
    updatePomodoro(pomodoro) { },
    updateSubject(subject, updateMode = UpdateMode.UPDATE) { }
};
export const WorkPanelContext = React.createContext(defaultController);
export default function WorkPanelView(props) {
    const parseData = (dataStr) => {
        return JSON.parse(dataStr);
    };
    const [workPanelData, setWorkPanelData] = React.useState(parseData(props.data));
    const ref = React.useRef(null);
    /**
     * 保存文件
     */
    useEffect(() => {
        props.saveData(JSON.stringify(workPanelData));
    }, [workPanelData]);
    const workPanelController = {
        plugin: props.plugin,
        updatePipeline(pipeline, updateMode = UpdateMode.UPDATE) {
            const originalPipelines = pipeline.isTemplate ? workPanelData.templates : workPanelData.workflows;
            const newPipelines = [];
            for (let i = 0; i < originalPipelines.length; i++) {
                if (originalPipelines[i].id != pipeline.id) {
                    newPipelines.push(originalPipelines[i]);
                }
                else if (updateMode == UpdateMode.UPDATE) {
                    newPipelines.push(pipeline);
                }
            }
            if (updateMode == UpdateMode.ADD) {
                newPipelines.push(pipeline);
            }
            setWorkPanelData(Object.assign({}, workPanelData, pipeline.isTemplate ? { templates: newPipelines } : { workflows: newPipelines }));
        },
        updateSection(pipeline, section, updateMode = UpdateMode.UPDATE) {
            const originalSections = pipeline.sections;
            const newSections = [];
            for (let i = 0; i < originalSections.length; i++) {
                if (originalSections[i].id !== section.id) {
                    newSections.push(originalSections[i]);
                }
                else if (updateMode == UpdateMode.UPDATE) {
                    newSections.push(section);
                }
            }
            if (updateMode == UpdateMode.ADD) {
                newSections.push(section);
            }
            this.updatePipeline(Object.assign({}, pipeline, { sections: newSections }));
        },
        updateNode(pipeline, section, node, updateMode = UpdateMode.UPDATE) {
            const originalNodes = section.nodes;
            const newNodes = [];
            for (let i = 0; i < originalNodes.length; i++) {
                if (originalNodes[i].id !== node.id) {
                    newNodes.push(originalNodes[i]);
                }
                else if (updateMode == UpdateMode.UPDATE) {
                    newNodes.push(node);
                }
            }
            if (updateMode == UpdateMode.ADD) {
                newNodes.push(node);
            }
            this.updateSection(pipeline, Object.assign({}, section, { nodes: newNodes }));
        },
        updatePomodoro(pomodoro, updateMode = UpdateMode.UPDATE) {
            const originalPomodoro = workPanelData.pomodoro;
            const newPomodoro = [];
            for (let i = 0; i < originalPomodoro.length; i++) {
                if (originalPomodoro[i].id != pomodoro.id) {
                    newPomodoro.push(originalPomodoro[i]);
                }
                else if (updateMode == UpdateMode.UPDATE) {
                    newPomodoro.push(pomodoro);
                }
            }
            if (updateMode == UpdateMode.ADD) {
                newPomodoro.push(pomodoro);
            }
            setWorkPanelData(Object.assign({}, workPanelData, { pomodoro: newPomodoro }));
        },
        updateSubject(subject, updateMode = UpdateMode.UPDATE) {
            const originalSubject = workPanelData.subject;
            const parentSubject = subject.parentID == originalSubject.id ? originalSubject
                : searchParentSubject(originalSubject, subject.parentID);
            if (!parentSubject) {
                return;
            }
            const newChildren = [];
            for (let i = 0; i < parentSubject.children.length; i++) {
                if (parentSubject.children[i].id != subject.id) {
                    newChildren.push(parentSubject.children[i]);
                }
                else if (updateMode == UpdateMode.UPDATE) {
                    newChildren.push(subject);
                }
            }
            if (updateMode == UpdateMode.ADD) {
                newChildren.push(subject);
            }
            parentSubject.children = newChildren;
            setWorkPanelData(Object.assign({}, workPanelData));
        }
    };
    const searchParentSubject = (rootSubject, parentSubjectID) => {
        for (let i = 0; i < rootSubject.children.length; i++) {
            if (rootSubject.children[i].id == parentSubjectID) {
                return rootSubject.children[i];
            }
            else {
                const searchResult = searchParentSubject(rootSubject.children[i], parentSubjectID);
                if (searchResult != null) {
                    return searchResult;
                }
            }
        }
        return null;
    };
    return (React.createElement(WorkPanelContext.Provider, { value: workPanelController },
        React.createElement("div", { style: { width: '100%', height: '100%' }, ref: ref },
            React.createElement(WorkflowView, { workflows: workPanelData.workflows, templates: workPanelData.templates, pomodoro: workPanelData.pomodoro, subject: workPanelData.subject }))));
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiV29ya1BhbmVsLnZpZXcuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJXb3JrUGFuZWwudmlldy50c3giXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxLQUFLLEtBQUssTUFBTSxPQUFPLENBQUM7QUFDL0IsT0FBTyxFQUFDLFNBQVMsRUFBQyxNQUFNLE9BQU8sQ0FBQztBQUNoQyxPQUFPLFlBQVksTUFBTSwyQkFBMkIsQ0FBQztBQUVyRCxPQUFPLEVBQUMsVUFBVSxFQUFzQixNQUFNLHdCQUF3QixDQUFDO0FBbUJ2RSxNQUFNLGlCQUFpQixHQUF3QjtJQUM5QyxNQUFNLEVBQUcsU0FBUztJQUNsQixjQUFjLENBQUMsUUFBdUIsSUFBRyxDQUFDO0lBQzFDLGFBQWEsQ0FBQyxRQUF1QixFQUFFLE9BQXFCLElBQUcsQ0FBQztJQUNoRSxVQUFVLENBQUMsUUFBdUIsRUFBRSxPQUFxQixFQUFFLElBQWUsSUFBRyxDQUFDO0lBQzlFLGNBQWMsQ0FBQyxRQUF1QixJQUFHLENBQUM7SUFDMUMsYUFBYSxDQUFDLE9BQXFCLEVBQUUsYUFBeUIsVUFBVSxDQUFDLE1BQU0sSUFBRyxDQUFDO0NBQ25GLENBQUE7QUFDRCxNQUFNLENBQUMsTUFBTSxnQkFBZ0IsR0FBRyxLQUFLLENBQUMsYUFBYSxDQUFDLGlCQUFpQixDQUFDLENBQUE7QUFFdEUsTUFBTSxDQUFDLE9BQU8sVUFBVSxhQUFhLENBQUMsS0FBcUI7SUFFMUQsTUFBTSxTQUFTLEdBQUcsQ0FBQyxPQUFlLEVBQWtCLEVBQUU7UUFDckQsT0FBTyxJQUFJLENBQUMsS0FBSyxDQUFDLE9BQU8sQ0FBQyxDQUFBO0lBQzNCLENBQUMsQ0FBQTtJQUVELE1BQU0sQ0FBQyxhQUFhLEVBQUUsZ0JBQWdCLENBQUMsR0FBRyxLQUFLLENBQUMsUUFBUSxDQUFDLFNBQVMsQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQTtJQUMvRSxNQUFNLEdBQUcsR0FBRyxLQUFLLENBQUMsTUFBTSxDQUFpQixJQUFJLENBQUMsQ0FBQztJQUUvQzs7T0FFRztJQUNILFNBQVMsQ0FBQyxHQUFHLEVBQUU7UUFDZCxLQUFLLENBQUMsUUFBUSxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsYUFBYSxDQUFDLENBQUMsQ0FBQTtJQUM5QyxDQUFDLEVBQUUsQ0FBQyxhQUFhLENBQUMsQ0FBQyxDQUFBO0lBRW5CLE1BQU0sbUJBQW1CLEdBQXdCO1FBQ2hELE1BQU0sRUFBRyxLQUFLLENBQUMsTUFBTTtRQUNyQixjQUFjLENBQUMsUUFBdUIsRUFBRSxhQUF5QixVQUFVLENBQUMsTUFBTTtZQUNqRixNQUFNLGlCQUFpQixHQUFHLFFBQVEsQ0FBQyxVQUFVLENBQUMsQ0FBQyxDQUFDLGFBQWEsQ0FBQyxTQUFTLENBQUMsQ0FBQyxDQUFDLGFBQWEsQ0FBQyxTQUFTLENBQUE7WUFDakcsTUFBTSxZQUFZLEdBQUcsRUFBRSxDQUFBO1lBQ3ZCLEtBQUssSUFBSSxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUMsR0FBRyxpQkFBaUIsQ0FBQyxNQUFNLEVBQUUsQ0FBQyxFQUFFLEVBQUU7Z0JBQ2xELElBQUksaUJBQWlCLENBQUMsQ0FBQyxDQUFDLENBQUMsRUFBRSxJQUFJLFFBQVEsQ0FBQyxFQUFFLEVBQUU7b0JBQzNDLFlBQVksQ0FBQyxJQUFJLENBQUMsaUJBQWlCLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQTtpQkFDM0I7cUJBQU0sSUFBSSxVQUFVLElBQUksVUFBVSxDQUFDLE1BQU0sRUFBRTtvQkFDdkQsWUFBWSxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUMsQ0FBQTtpQkFDM0I7YUFDUTtZQUNWLElBQUksVUFBVSxJQUFJLFVBQVUsQ0FBQyxHQUFHLEVBQUU7Z0JBQ2pDLFlBQVksQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLENBQUE7YUFDM0I7WUFDRCxnQkFBZ0IsQ0FBQyxNQUFNLENBQUMsTUFBTSxDQUFDLEVBQUUsRUFBRSxhQUFhLEVBQUUsUUFBUSxDQUFDLFVBQVUsQ0FBQyxDQUFDLENBQUMsRUFBQyxTQUFTLEVBQUUsWUFBWSxFQUFDLENBQUMsQ0FBQyxDQUFDLEVBQUMsU0FBUyxFQUFFLFlBQVksRUFBQyxDQUFDLENBQUMsQ0FBQTtRQUNoSSxDQUFDO1FBQ0QsYUFBYSxDQUFDLFFBQXVCLEVBQUUsT0FBcUIsRUFBRSxhQUF5QixVQUFVLENBQUMsTUFBTTtZQUN2RyxNQUFNLGdCQUFnQixHQUFHLFFBQVEsQ0FBQyxRQUFRLENBQUE7WUFDakMsTUFBTSxXQUFXLEdBQUcsRUFBRSxDQUFBO1lBQ3RCLEtBQUssSUFBSSxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUMsR0FBRyxnQkFBZ0IsQ0FBQyxNQUFNLEVBQUUsQ0FBQyxFQUFFLEVBQUU7Z0JBQzlDLElBQUksZ0JBQWdCLENBQUMsQ0FBQyxDQUFDLENBQUMsRUFBRSxLQUFLLE9BQU8sQ0FBQyxFQUFFLEVBQUU7b0JBQ3ZDLFdBQVcsQ0FBQyxJQUFJLENBQUMsZ0JBQWdCLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQTtpQkFDeEM7cUJBQU0sSUFBSSxVQUFVLElBQUksVUFBVSxDQUFDLE1BQU0sRUFBRTtvQkFDdkQsV0FBVyxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsQ0FBQTtpQkFDekI7YUFDUTtZQUNWLElBQUksVUFBVSxJQUFJLFVBQVUsQ0FBQyxHQUFHLEVBQUU7Z0JBQ2pDLFdBQVcsQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLENBQUE7YUFDekI7WUFDRCxJQUFJLENBQUMsY0FBYyxDQUFDLE1BQU0sQ0FBQyxNQUFNLENBQUMsRUFBRSxFQUFFLFFBQVEsRUFBRSxFQUFDLFFBQVEsRUFBRSxXQUFXLEVBQUMsQ0FBQyxDQUFDLENBQUE7UUFDMUUsQ0FBQztRQUNELFVBQVUsQ0FBQyxRQUF1QixFQUFFLE9BQXFCLEVBQUUsSUFBZSxFQUFFLGFBQXlCLFVBQVUsQ0FBQyxNQUFNO1lBQ3JILE1BQU0sYUFBYSxHQUFHLE9BQU8sQ0FBQyxLQUFLLENBQUE7WUFDbkMsTUFBTSxRQUFRLEdBQUcsRUFBRSxDQUFBO1lBQ25CLEtBQUssSUFBSSxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUMsR0FBRyxhQUFhLENBQUMsTUFBTSxFQUFFLENBQUMsRUFBRSxFQUFFO2dCQUM5QyxJQUFJLGFBQWEsQ0FBQyxDQUFDLENBQUMsQ0FBQyxFQUFFLEtBQUssSUFBSSxDQUFDLEVBQUUsRUFBRTtvQkFDckIsUUFBUSxDQUFDLElBQUksQ0FBQyxhQUFhLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQTtpQkFDbEM7cUJBQU0sSUFBSSxVQUFVLElBQUksVUFBVSxDQUFDLE1BQU0sRUFBRTtvQkFDeEMsUUFBUSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQTtpQkFDdEI7YUFDSjtZQUNELElBQUksVUFBVSxJQUFJLFVBQVUsQ0FBQyxHQUFHLEVBQUU7Z0JBQzFDLFFBQVEsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUE7YUFDbkI7WUFDRCxJQUFJLENBQUMsYUFBYSxDQUFDLFFBQVEsRUFBRSxNQUFNLENBQUMsTUFBTSxDQUFDLEVBQUUsRUFBRSxPQUFPLEVBQUUsRUFBQyxLQUFLLEVBQUUsUUFBUSxFQUFDLENBQUMsQ0FBQyxDQUFBO1FBQzVFLENBQUM7UUFDRCxjQUFjLENBQUMsUUFBdUIsRUFBRSxhQUF5QixVQUFVLENBQUMsTUFBTTtZQUNqRixNQUFNLGdCQUFnQixHQUFHLGFBQWEsQ0FBQyxRQUFRLENBQUE7WUFDL0MsTUFBTSxXQUFXLEdBQUcsRUFBRSxDQUFBO1lBQ3RCLEtBQUssSUFBSSxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUMsR0FBRyxnQkFBZ0IsQ0FBQyxNQUFNLEVBQUUsQ0FBQyxFQUFFLEVBQUU7Z0JBQ2pELElBQUksZ0JBQWdCLENBQUMsQ0FBQyxDQUFDLENBQUMsRUFBRSxJQUFJLFFBQVEsQ0FBQyxFQUFFLEVBQUU7b0JBQzFDLFdBQVcsQ0FBQyxJQUFJLENBQUMsZ0JBQWdCLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQTtpQkFDckM7cUJBQU0sSUFBSSxVQUFVLElBQUksVUFBVSxDQUFDLE1BQU0sRUFBRTtvQkFDM0MsV0FBVyxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUMsQ0FBQTtpQkFDMUI7YUFDRDtZQUNELElBQUksVUFBVSxJQUFJLFVBQVUsQ0FBQyxHQUFHLEVBQUU7Z0JBQ2pDLFdBQVcsQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLENBQUE7YUFDMUI7WUFDRCxnQkFBZ0IsQ0FBQyxNQUFNLENBQUMsTUFBTSxDQUFDLEVBQUUsRUFBRSxhQUFhLEVBQUUsRUFBQyxRQUFRLEVBQUUsV0FBVyxFQUFDLENBQUMsQ0FBQyxDQUFBO1FBQzVFLENBQUM7UUFDRCxhQUFhLENBQUMsT0FBcUIsRUFBRSxhQUF5QixVQUFVLENBQUMsTUFBTTtZQUM5RSxNQUFNLGVBQWUsR0FBRyxhQUFhLENBQUMsT0FBTyxDQUFBO1lBQzdDLE1BQU0sYUFBYSxHQUFHLE9BQU8sQ0FBQyxRQUFRLElBQUksZUFBZSxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUMsZUFBZTtnQkFDN0UsQ0FBQyxDQUFDLG1CQUFtQixDQUFDLGVBQWUsRUFBRSxPQUFPLENBQUMsUUFBUSxDQUFDLENBQUE7WUFDekQsSUFBSSxDQUFDLGFBQWEsRUFBRTtnQkFDbkIsT0FBTTthQUNOO1lBQ0QsTUFBTSxXQUFXLEdBQUcsRUFBRSxDQUFBO1lBQ3RCLEtBQUssSUFBSSxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUMsR0FBRyxhQUFhLENBQUMsUUFBUSxDQUFDLE1BQU0sRUFBRSxDQUFDLEVBQUUsRUFBRTtnQkFDdkQsSUFBSSxhQUFhLENBQUMsUUFBUSxDQUFDLENBQUMsQ0FBQyxDQUFDLEVBQUUsSUFBSSxPQUFPLENBQUMsRUFBRSxFQUFFO29CQUMvQyxXQUFXLENBQUMsSUFBSSxDQUFDLGFBQWEsQ0FBQyxRQUFRLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQTtpQkFDM0M7cUJBQU0sSUFBSSxVQUFVLElBQUksVUFBVSxDQUFDLE1BQU0sRUFBRTtvQkFDM0MsV0FBVyxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsQ0FBQTtpQkFDekI7YUFDRDtZQUNELElBQUksVUFBVSxJQUFJLFVBQVUsQ0FBQyxHQUFHLEVBQUU7Z0JBQ2pDLFdBQVcsQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLENBQUE7YUFDekI7WUFDRCxhQUFhLENBQUMsUUFBUSxHQUFHLFdBQVcsQ0FBQTtZQUNwQyxnQkFBZ0IsQ0FBQyxNQUFNLENBQUMsTUFBTSxDQUFDLEVBQUUsRUFBRSxhQUFhLENBQUMsQ0FBQyxDQUFBO1FBQ25ELENBQUM7S0FDRCxDQUFBO0lBRUQsTUFBTSxtQkFBbUIsR0FBRyxDQUFDLFdBQXlCLEVBQUUsZUFBdUIsRUFBdUIsRUFBRTtRQUN2RyxLQUFLLElBQUksQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLEdBQUcsV0FBVyxDQUFDLFFBQVEsQ0FBQyxNQUFNLEVBQUUsQ0FBQyxFQUFFLEVBQUU7WUFDckQsSUFBSSxXQUFXLENBQUMsUUFBUSxDQUFDLENBQUMsQ0FBQyxDQUFDLEVBQUUsSUFBSSxlQUFlLEVBQUU7Z0JBQ2xELE9BQU8sV0FBVyxDQUFDLFFBQVEsQ0FBQyxDQUFDLENBQUMsQ0FBQTthQUM5QjtpQkFBTTtnQkFDTixNQUFNLFlBQVksR0FBRyxtQkFBbUIsQ0FBQyxXQUFXLENBQUMsUUFBUSxDQUFDLENBQUMsQ0FBQyxFQUFFLGVBQWUsQ0FBQyxDQUFBO2dCQUNsRixJQUFJLFlBQVksSUFBSSxJQUFJLEVBQUU7b0JBQ3pCLE9BQU8sWUFBWSxDQUFBO2lCQUNuQjthQUNEO1NBQ0Q7UUFDRCxPQUFPLElBQUksQ0FBQTtJQUNaLENBQUMsQ0FBQTtJQUVELE9BQU8sQ0FDTixvQkFBQyxnQkFBZ0IsQ0FBQyxRQUFRLElBQUMsS0FBSyxFQUFFLG1CQUFtQjtRQUNwRCw2QkFBSyxLQUFLLEVBQUUsRUFBRSxLQUFLLEVBQUUsTUFBTSxFQUFFLE1BQU0sRUFBRSxNQUFNLEVBQUMsRUFBRSxHQUFHLEVBQUUsR0FBRztZQUNyRCxvQkFBQyxZQUFZLElBQUMsU0FBUyxFQUFFLGFBQWEsQ0FBQyxTQUFTLEVBQUUsU0FBUyxFQUFFLGFBQWEsQ0FBQyxTQUFTLEVBQUUsUUFBUSxFQUFFLGFBQWEsQ0FBQyxRQUFRLEVBQUUsT0FBTyxFQUFFLGFBQWEsQ0FBQyxPQUFPLEdBQUcsQ0FDcEosQ0FDcUIsQ0FDNUIsQ0FBQztBQUNILENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgKiBhcyBSZWFjdCBmcm9tICdyZWFjdCc7XHJcbmltcG9ydCB7dXNlRWZmZWN0fSBmcm9tICdyZWFjdCc7XHJcbmltcG9ydCBXb3JrZmxvd1ZpZXcgZnJvbSBcIi4uL3dvcmtmbG93L1dvcmtmbG93LnZpZXdcIjtcclxuaW1wb3J0IHtQaXBlbGluZU1vZGVsLCBTZWN0aW9uTW9kZWx9IGZyb20gXCIuLi9waXBlbGluZS9QaXBlbGluZS5tb2RlbFwiO1xyXG5pbXBvcnQge1VwZGF0ZU1vZGUsIFdvcmtQYW5lbENvbnRyb2xsZXJ9IGZyb20gXCIuL1dvcmtQYW5lbC5jb250cm9sbGVyXCI7XHJcbmltcG9ydCB7V29ya1BhbmVsTW9kZWx9IGZyb20gXCIuL1dvcmtQYW5lbC5tb2RlbFwiO1xyXG5pbXBvcnQge05vZGVNb2RlbH0gZnJvbSBcIi4uL25vZGVzL05vZGUubW9kZWxcIjtcclxuaW1wb3J0IFdvcmtmbG93UGx1Z2luIGZyb20gXCIuLi8uLi9tYWluXCI7XHJcbmltcG9ydCB7UG9tb2Rvcm9Nb2RlbH0gZnJvbSBcIi4uL3BvbW9kb3JvL1BvbW9kb3JvLm1vZGVsXCI7XHJcbmltcG9ydCB7U3ViamVjdE1vZGVsfSBmcm9tIFwiLi4vc3ViamVjdC9TdWJqZWN0Lm1vZGVsXCI7XHJcblxyXG4vKipcclxuICogVGhpcyBpcyB0aGUgbWFpbiBpbnRlcmZhY2Ugb2Ygd29ya2Zsb3dzLlxyXG4gKiDliIfmjaLliLDlupXpg6jlr7zoiKrmlrnmoYhcclxuICogQGF1dGhvcjogc29sYXJlQHllYWgubmV0XHJcbiAqL1xyXG5cclxuaW50ZXJmYWNlIFdvcmtQYW5lbFByb3BzIHtcclxuXHRkYXRhOiBzdHJpbmdcclxuXHRzYXZlRGF0YTogKGRhdGFTdHI6IHN0cmluZyk9PnZvaWRcclxuXHRwbHVnaW46IFdvcmtmbG93UGx1Z2luXHJcbn1cclxuXHJcbmNvbnN0IGRlZmF1bHRDb250cm9sbGVyOiBXb3JrUGFuZWxDb250cm9sbGVyID0ge1xyXG5cdHBsdWdpbiA6IHVuZGVmaW5lZCxcclxuXHR1cGRhdGVQaXBlbGluZShwaXBlbGluZTogUGlwZWxpbmVNb2RlbCkge30sXHJcblx0dXBkYXRlU2VjdGlvbihwaXBlbGluZTogUGlwZWxpbmVNb2RlbCwgc2VjdGlvbjogU2VjdGlvbk1vZGVsKSB7fSxcclxuXHR1cGRhdGVOb2RlKHBpcGVsaW5lOiBQaXBlbGluZU1vZGVsLCBzZWN0aW9uOiBTZWN0aW9uTW9kZWwsIG5vZGU6IE5vZGVNb2RlbCkge30sXHJcblx0dXBkYXRlUG9tb2Rvcm8ocG9tb2Rvcm86IFBvbW9kb3JvTW9kZWwpIHt9LFxyXG5cdHVwZGF0ZVN1YmplY3Qoc3ViamVjdDogU3ViamVjdE1vZGVsLCB1cGRhdGVNb2RlOiBVcGRhdGVNb2RlID0gVXBkYXRlTW9kZS5VUERBVEUpIHt9XHJcbn1cclxuZXhwb3J0IGNvbnN0IFdvcmtQYW5lbENvbnRleHQgPSBSZWFjdC5jcmVhdGVDb250ZXh0KGRlZmF1bHRDb250cm9sbGVyKVxyXG5cclxuZXhwb3J0IGRlZmF1bHQgZnVuY3Rpb24gV29ya1BhbmVsVmlldyhwcm9wczogV29ya1BhbmVsUHJvcHMpIHtcclxuXHJcblx0Y29uc3QgcGFyc2VEYXRhID0gKGRhdGFTdHI6IHN0cmluZyk6IFdvcmtQYW5lbE1vZGVsID0+IHtcclxuXHRcdHJldHVybiBKU09OLnBhcnNlKGRhdGFTdHIpXHJcblx0fVxyXG5cclxuXHRjb25zdCBbd29ya1BhbmVsRGF0YSwgc2V0V29ya1BhbmVsRGF0YV0gPSBSZWFjdC51c2VTdGF0ZShwYXJzZURhdGEocHJvcHMuZGF0YSkpXHJcblx0Y29uc3QgcmVmID0gUmVhY3QudXNlUmVmPEhUTUxEaXZFbGVtZW50PihudWxsKTtcclxuXHJcblx0LyoqXHJcblx0ICog5L+d5a2Y5paH5Lu2XHJcblx0ICovXHJcblx0dXNlRWZmZWN0KCgpID0+IHtcclxuXHRcdHByb3BzLnNhdmVEYXRhKEpTT04uc3RyaW5naWZ5KHdvcmtQYW5lbERhdGEpKVxyXG5cdH0sIFt3b3JrUGFuZWxEYXRhXSlcclxuXHJcblx0Y29uc3Qgd29ya1BhbmVsQ29udHJvbGxlcjogV29ya1BhbmVsQ29udHJvbGxlciA9IHtcclxuXHRcdHBsdWdpbiA6IHByb3BzLnBsdWdpbixcclxuXHRcdHVwZGF0ZVBpcGVsaW5lKHBpcGVsaW5lOiBQaXBlbGluZU1vZGVsLCB1cGRhdGVNb2RlOiBVcGRhdGVNb2RlID0gVXBkYXRlTW9kZS5VUERBVEUpIHtcclxuXHRcdFx0Y29uc3Qgb3JpZ2luYWxQaXBlbGluZXMgPSBwaXBlbGluZS5pc1RlbXBsYXRlID8gd29ya1BhbmVsRGF0YS50ZW1wbGF0ZXMgOiB3b3JrUGFuZWxEYXRhLndvcmtmbG93c1xyXG5cdFx0XHRjb25zdCBuZXdQaXBlbGluZXMgPSBbXVxyXG5cdFx0XHRmb3IgKGxldCBpID0gMDsgaSA8IG9yaWdpbmFsUGlwZWxpbmVzLmxlbmd0aDsgaSsrKSB7XHJcblx0XHRcdFx0aWYgKG9yaWdpbmFsUGlwZWxpbmVzW2ldLmlkICE9IHBpcGVsaW5lLmlkKSB7XHJcblx0XHRcdFx0XHRuZXdQaXBlbGluZXMucHVzaChvcmlnaW5hbFBpcGVsaW5lc1tpXSlcclxuICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAodXBkYXRlTW9kZSA9PSBVcGRhdGVNb2RlLlVQREFURSkge1xyXG5cdFx0XHRcdFx0bmV3UGlwZWxpbmVzLnB1c2gocGlwZWxpbmUpXHJcblx0XHRcdFx0fVxyXG4gICAgICAgICAgICB9XHJcblx0XHRcdGlmICh1cGRhdGVNb2RlID09IFVwZGF0ZU1vZGUuQUREKSB7XHJcblx0XHRcdFx0bmV3UGlwZWxpbmVzLnB1c2gocGlwZWxpbmUpXHJcblx0XHRcdH1cclxuXHRcdFx0c2V0V29ya1BhbmVsRGF0YShPYmplY3QuYXNzaWduKHt9LCB3b3JrUGFuZWxEYXRhLCBwaXBlbGluZS5pc1RlbXBsYXRlID8ge3RlbXBsYXRlczogbmV3UGlwZWxpbmVzfSA6IHt3b3JrZmxvd3M6IG5ld1BpcGVsaW5lc30pKVxyXG5cdFx0fSxcclxuXHRcdHVwZGF0ZVNlY3Rpb24ocGlwZWxpbmU6IFBpcGVsaW5lTW9kZWwsIHNlY3Rpb246IFNlY3Rpb25Nb2RlbCwgdXBkYXRlTW9kZTogVXBkYXRlTW9kZSA9IFVwZGF0ZU1vZGUuVVBEQVRFKSB7XHJcblx0XHRcdGNvbnN0IG9yaWdpbmFsU2VjdGlvbnMgPSBwaXBlbGluZS5zZWN0aW9uc1xyXG4gICAgICAgICAgICBjb25zdCBuZXdTZWN0aW9ucyA9IFtdXHJcbiAgICAgICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgb3JpZ2luYWxTZWN0aW9ucy5sZW5ndGg7IGkrKykge1xyXG4gICAgICAgICAgICAgICAgaWYgKG9yaWdpbmFsU2VjdGlvbnNbaV0uaWQgIT09IHNlY3Rpb24uaWQpIHtcclxuICAgICAgICAgICAgICAgICAgICBuZXdTZWN0aW9ucy5wdXNoKG9yaWdpbmFsU2VjdGlvbnNbaV0pXHJcbiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHVwZGF0ZU1vZGUgPT0gVXBkYXRlTW9kZS5VUERBVEUpIHtcclxuXHRcdFx0XHRcdG5ld1NlY3Rpb25zLnB1c2goc2VjdGlvbilcclxuXHRcdFx0XHR9XHJcbiAgICAgICAgICAgIH1cclxuXHRcdFx0aWYgKHVwZGF0ZU1vZGUgPT0gVXBkYXRlTW9kZS5BREQpIHtcclxuXHRcdFx0XHRuZXdTZWN0aW9ucy5wdXNoKHNlY3Rpb24pXHJcblx0XHRcdH1cclxuXHRcdFx0dGhpcy51cGRhdGVQaXBlbGluZShPYmplY3QuYXNzaWduKHt9LCBwaXBlbGluZSwge3NlY3Rpb25zOiBuZXdTZWN0aW9uc30pKVxyXG5cdFx0fSxcclxuXHRcdHVwZGF0ZU5vZGUocGlwZWxpbmU6IFBpcGVsaW5lTW9kZWwsIHNlY3Rpb246IFNlY3Rpb25Nb2RlbCwgbm9kZTogTm9kZU1vZGVsLCB1cGRhdGVNb2RlOiBVcGRhdGVNb2RlID0gVXBkYXRlTW9kZS5VUERBVEUpIHtcclxuXHRcdFx0Y29uc3Qgb3JpZ2luYWxOb2RlcyA9IHNlY3Rpb24ubm9kZXNcclxuXHRcdFx0Y29uc3QgbmV3Tm9kZXMgPSBbXVxyXG5cdFx0XHRmb3IgKGxldCBpID0gMDsgaSA8IG9yaWdpbmFsTm9kZXMubGVuZ3RoOyBpKyspIHtcclxuXHRcdFx0XHRpZiAob3JpZ2luYWxOb2Rlc1tpXS5pZCAhPT0gbm9kZS5pZCkge1xyXG4gICAgICAgICAgICAgICAgICAgIG5ld05vZGVzLnB1c2gob3JpZ2luYWxOb2Rlc1tpXSlcclxuICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAodXBkYXRlTW9kZSA9PSBVcGRhdGVNb2RlLlVQREFURSkge1xyXG4gICAgICAgICAgICAgICAgICAgIG5ld05vZGVzLnB1c2gobm9kZSlcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBpZiAodXBkYXRlTW9kZSA9PSBVcGRhdGVNb2RlLkFERCkge1xyXG5cdFx0XHRcdG5ld05vZGVzLnB1c2gobm9kZSlcclxuXHRcdFx0fVxyXG5cdFx0XHR0aGlzLnVwZGF0ZVNlY3Rpb24ocGlwZWxpbmUsIE9iamVjdC5hc3NpZ24oe30sIHNlY3Rpb24sIHtub2RlczogbmV3Tm9kZXN9KSlcclxuXHRcdH0sXHJcblx0XHR1cGRhdGVQb21vZG9ybyhwb21vZG9ybzogUG9tb2Rvcm9Nb2RlbCwgdXBkYXRlTW9kZTogVXBkYXRlTW9kZSA9IFVwZGF0ZU1vZGUuVVBEQVRFKSB7XHJcblx0XHRcdGNvbnN0IG9yaWdpbmFsUG9tb2Rvcm8gPSB3b3JrUGFuZWxEYXRhLnBvbW9kb3JvXHJcblx0XHRcdGNvbnN0IG5ld1BvbW9kb3JvID0gW11cclxuXHRcdFx0Zm9yIChsZXQgaSA9IDA7IGkgPCBvcmlnaW5hbFBvbW9kb3JvLmxlbmd0aDsgaSsrKSB7XHJcblx0XHRcdFx0aWYgKG9yaWdpbmFsUG9tb2Rvcm9baV0uaWQgIT0gcG9tb2Rvcm8uaWQpIHtcclxuXHRcdFx0XHRcdG5ld1BvbW9kb3JvLnB1c2gob3JpZ2luYWxQb21vZG9yb1tpXSlcclxuXHRcdFx0XHR9IGVsc2UgaWYgKHVwZGF0ZU1vZGUgPT0gVXBkYXRlTW9kZS5VUERBVEUpIHtcclxuXHRcdFx0XHRcdG5ld1BvbW9kb3JvLnB1c2gocG9tb2Rvcm8pXHJcblx0XHRcdFx0fVxyXG5cdFx0XHR9XHJcblx0XHRcdGlmICh1cGRhdGVNb2RlID09IFVwZGF0ZU1vZGUuQUREKSB7XHJcblx0XHRcdFx0bmV3UG9tb2Rvcm8ucHVzaChwb21vZG9ybylcclxuXHRcdFx0fVxyXG5cdFx0XHRzZXRXb3JrUGFuZWxEYXRhKE9iamVjdC5hc3NpZ24oe30sIHdvcmtQYW5lbERhdGEsIHtwb21vZG9ybzogbmV3UG9tb2Rvcm99KSlcclxuXHRcdH0sXHJcblx0XHR1cGRhdGVTdWJqZWN0KHN1YmplY3Q6IFN1YmplY3RNb2RlbCwgdXBkYXRlTW9kZTogVXBkYXRlTW9kZSA9IFVwZGF0ZU1vZGUuVVBEQVRFKSB7XHJcblx0XHRcdGNvbnN0IG9yaWdpbmFsU3ViamVjdCA9IHdvcmtQYW5lbERhdGEuc3ViamVjdFxyXG5cdFx0XHRjb25zdCBwYXJlbnRTdWJqZWN0ID0gc3ViamVjdC5wYXJlbnRJRCA9PSBvcmlnaW5hbFN1YmplY3QuaWQgPyBvcmlnaW5hbFN1YmplY3RcclxuXHRcdFx0XHQ6IHNlYXJjaFBhcmVudFN1YmplY3Qob3JpZ2luYWxTdWJqZWN0LCBzdWJqZWN0LnBhcmVudElEKVxyXG5cdFx0XHRpZiAoIXBhcmVudFN1YmplY3QpIHtcclxuXHRcdFx0XHRyZXR1cm5cclxuXHRcdFx0fVxyXG5cdFx0XHRjb25zdCBuZXdDaGlsZHJlbiA9IFtdXHJcblx0XHRcdGZvciAobGV0IGkgPSAwOyBpIDwgcGFyZW50U3ViamVjdC5jaGlsZHJlbi5sZW5ndGg7IGkrKykge1xyXG5cdFx0XHRcdGlmIChwYXJlbnRTdWJqZWN0LmNoaWxkcmVuW2ldLmlkICE9IHN1YmplY3QuaWQpIHtcclxuXHRcdFx0XHRcdG5ld0NoaWxkcmVuLnB1c2gocGFyZW50U3ViamVjdC5jaGlsZHJlbltpXSlcclxuXHRcdFx0XHR9IGVsc2UgaWYgKHVwZGF0ZU1vZGUgPT0gVXBkYXRlTW9kZS5VUERBVEUpIHtcclxuXHRcdFx0XHRcdG5ld0NoaWxkcmVuLnB1c2goc3ViamVjdClcclxuXHRcdFx0XHR9XHJcblx0XHRcdH1cclxuXHRcdFx0aWYgKHVwZGF0ZU1vZGUgPT0gVXBkYXRlTW9kZS5BREQpIHtcclxuXHRcdFx0XHRuZXdDaGlsZHJlbi5wdXNoKHN1YmplY3QpXHJcblx0XHRcdH1cclxuXHRcdFx0cGFyZW50U3ViamVjdC5jaGlsZHJlbiA9IG5ld0NoaWxkcmVuXHJcblx0XHRcdHNldFdvcmtQYW5lbERhdGEoT2JqZWN0LmFzc2lnbih7fSwgd29ya1BhbmVsRGF0YSkpXHJcblx0XHR9XHJcblx0fVxyXG5cclxuXHRjb25zdCBzZWFyY2hQYXJlbnRTdWJqZWN0ID0gKHJvb3RTdWJqZWN0OiBTdWJqZWN0TW9kZWwsIHBhcmVudFN1YmplY3RJRDogc3RyaW5nKTogU3ViamVjdE1vZGVsIHwgbnVsbCA9PiB7XHJcblx0XHRmb3IgKGxldCBpID0gMDsgaSA8IHJvb3RTdWJqZWN0LmNoaWxkcmVuLmxlbmd0aDsgaSsrKSB7XHJcblx0XHRcdGlmIChyb290U3ViamVjdC5jaGlsZHJlbltpXS5pZCA9PSBwYXJlbnRTdWJqZWN0SUQpIHtcclxuXHRcdFx0XHRyZXR1cm4gcm9vdFN1YmplY3QuY2hpbGRyZW5baV1cclxuXHRcdFx0fSBlbHNlIHtcclxuXHRcdFx0XHRjb25zdCBzZWFyY2hSZXN1bHQgPSBzZWFyY2hQYXJlbnRTdWJqZWN0KHJvb3RTdWJqZWN0LmNoaWxkcmVuW2ldLCBwYXJlbnRTdWJqZWN0SUQpXHJcblx0XHRcdFx0aWYgKHNlYXJjaFJlc3VsdCAhPSBudWxsKSB7XHJcblx0XHRcdFx0XHRyZXR1cm4gc2VhcmNoUmVzdWx0XHJcblx0XHRcdFx0fVxyXG5cdFx0XHR9XHJcblx0XHR9XHJcblx0XHRyZXR1cm4gbnVsbFxyXG5cdH1cclxuXHJcblx0cmV0dXJuIChcclxuXHRcdDxXb3JrUGFuZWxDb250ZXh0LlByb3ZpZGVyIHZhbHVlPXt3b3JrUGFuZWxDb250cm9sbGVyfSA+XHJcblx0XHRcdDxkaXYgc3R5bGU9e3sgd2lkdGg6ICcxMDAlJywgaGVpZ2h0OiAnMTAwJSd9fSByZWY9e3JlZn0+XHJcblx0XHRcdFx0PFdvcmtmbG93VmlldyB3b3JrZmxvd3M9e3dvcmtQYW5lbERhdGEud29ya2Zsb3dzfSB0ZW1wbGF0ZXM9e3dvcmtQYW5lbERhdGEudGVtcGxhdGVzfSBwb21vZG9ybz17d29ya1BhbmVsRGF0YS5wb21vZG9yb30gc3ViamVjdD17d29ya1BhbmVsRGF0YS5zdWJqZWN0fS8+XHJcblx0XHRcdDwvZGl2PlxyXG5cdFx0PC9Xb3JrUGFuZWxDb250ZXh0LlByb3ZpZGVyPlxyXG5cdCk7XHJcbn1cclxuIl19