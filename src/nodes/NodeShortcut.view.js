import { Divider, Typography } from "@mui/material";
import { Platform, TFile, Vault } from "obsidian";
import PlayCircleFilledWhiteIcon from "@mui/icons-material/PlayCircleFilledWhite";
import * as React from "react";
import { useContext, useEffect, useState } from "react";
import { CommandType } from "./Command";
import { TimeUtils } from "../utils/Time.utils";
import { getVaultBasePath, replaceAllSlashes } from "../settings/SettingHelper";
import { WorkPanelContext } from "../workpanel/WorkPanel.view";
import { getAllFolders, openFileInNewLeaf } from "../utils/File.utils";
export default function NodeShortcutView(nodeViewProps) {
    const workPanelController = useContext(WorkPanelContext);
    const { editorMode, nodeShortCutModel, onUpdateShortCut } = nodeViewProps;
    const shortCutCommand = Platform.isMacOS ? nodeShortCutModel.macCommand : nodeShortCutModel.command;
    const [shortCutName, setShortcutName] = useState(nodeShortCutModel.name || '');
    const [shortCutCommandType, setShortCutCommandType] = useState(shortCutCommand.type);
    useEffect(() => {
        setShortcutName((nodeShortCutModel === null || nodeShortCutModel === void 0 ? void 0 : nodeShortCutModel.name) || '');
        setShortCutCommandType(shortCutCommand.type);
    }, [nodeShortCutModel]);
    /**
     * here are the order sequence on Windows
     * 1. switch volume (like D:)
     * 2. cd to the folder that contains the script
     * 3. run the script with commandFolder as argument
     * Only .bat file is supported
     */
    const getWindowsCommand = () => {
        const vaultPath = getVaultBasePath(app);
        const commandPath = `${vaultPath}/${shortCutCommand.commandFile}`;
        const commandFolderPath = replaceAllSlashes(commandPath.substring(0, commandPath.lastIndexOf('/')));
        const scriptName = shortCutCommand.commandFile.substring(shortCutCommand.commandFile.lastIndexOf('/') + 1);
        const commandFolder = `${vaultPath}/${shortCutCommand.commandFolder}`;
        const commandDescFolderPath = replaceAllSlashes(commandFolder.substring(0, commandFolder.lastIndexOf('/')));
        let switchVolume = vaultPath.substring(0, vaultPath.lastIndexOf(':') + 1);
        return `${switchVolume} & cd ${commandFolderPath} & ${scriptName} "${commandDescFolderPath}"`;
    };
    /**
     * to be decided on MacOS
     */
    const getMacCommand = () => {
        const vaultPath = getVaultBasePath(app);
        const commandPath = `${vaultPath}/${shortCutCommand.commandFile}`;
        const commandFolder = `${vaultPath}/${shortCutCommand.commandFolder}`;
        return `${commandPath}`;
    };
    const getMacCommandFolder = () => {
        const vaultPath = getVaultBasePath(app);
        const commandFolder = `${vaultPath}/${shortCutCommand.commandFolder}`;
        return `"${commandFolder}"`;
    };
    // execute the stored command
    const onShortcutClick = () => {
        if (!Platform.isDesktop) {
            return;
        }
        // execute the shell command in a sub-process, folder is passed as an argument
        // can`t be used because not enter the folder
        if (shortCutCommand.type === CommandType.SHELL) {
            if (!shortCutCommand.commandFile) {
                return;
            }
            if (Platform.isMacOS) {
                console.log("file path: ", getMacCommand());
                const result = require('child_process').execFile(getMacCommand(), [getMacCommandFolder()]);
            }
            else {
                require('child_process').exec(getWindowsCommand(), { encoding: 'utf-8' });
            }
        }
        else if (shortCutCommand.type === CommandType.COPY_FILE) {
            if (!shortCutCommand.commandFile || !shortCutCommand.commandFolder) {
                return;
            }
            const originalFileName = shortCutCommand.commandFile.substring(shortCutCommand.commandFile.lastIndexOf('/') + 1);
            const newFilePath = `${shortCutCommand.commandFolder}${TimeUtils.getDateStr(Date.now())}-${originalFileName}`;
            app.vault.adapter.exists(newFilePath).then((exist) => {
                if (exist) {
                    openFileInNewLeaf(newFilePath, app);
                }
                else {
                    app.vault.adapter.copy(shortCutCommand.commandFile, newFilePath).then(() => {
                        openFileInNewLeaf(newFilePath, app);
                    });
                }
            });
        }
        else if (shortCutCommand.type === CommandType.OPEN_FILE) {
            if (!shortCutCommand.commandFile) {
                return;
            }
            openFileInNewLeaf(shortCutCommand.commandFile, app);
        }
    };
    const handleNodeShortcutNameChange = (event) => {
        setShortcutName(event.target.value);
        nodeShortCutModel.name = event.target.value;
        onUpdateShortCut(nodeShortCutModel);
    };
    const handleNodeShortcutTypeChange = (event) => {
        const commandType = event.target.value;
        if (commandType === shortCutCommand.type) {
            return;
        }
        setShortCutCommandType(commandType);
        shortCutCommand.type = commandType;
        onUpdateShortCut(nodeShortCutModel);
    };
    const handleNodeShortcutFileChange = (event) => {
        shortCutCommand.commandFile = event.target.value;
        onUpdateShortCut(nodeShortCutModel);
    };
    const handleNodeShortcutFolderChange = (event) => {
        shortCutCommand.commandFolder = event.target.value;
        onUpdateShortCut(nodeShortCutModel);
    };
    const getTypeOptions = () => {
        const options = [];
        options.push(React.createElement("option", { value: CommandType.SHELL }, CommandType.SHELL));
        options.push(React.createElement("option", { value: CommandType.COPY_FILE }, CommandType.COPY_FILE));
        options.push(React.createElement("option", { value: CommandType.OPEN_FILE }, CommandType.OPEN_FILE));
        return options;
    };
    useEffect(() => {
        getScriptOptions();
    });
    const getScriptOptions = () => {
        var _a;
        const options = [];
        const settings = (_a = workPanelController.plugin) === null || _a === void 0 ? void 0 : _a.settings;
        const shellFolder = app.vault.getAbstractFileByPath((settings === null || settings === void 0 ? void 0 : settings.scriptPath) || '');
        Vault.recurseChildren(shellFolder, (f) => {
            if (f instanceof TFile) {
                if (!Platform.isMacOS && f.extension.toLowerCase() !== 'bat') {
                    return;
                }
                if (Platform.isMacOS && f.extension.toLowerCase() !== 'sh') {
                    return;
                }
                options.push(React.createElement("option", { value: f.path }, f.path));
            }
        });
        return options;
    };
    const getFileOptions = () => {
        const options = [];
        const files = app.vault.getFiles();
        for (const file of files) {
            options.push(React.createElement("option", { key: file.path, value: file.path }, file.path));
        }
        return options;
    };
    const getFolderOptions = () => {
        const options = [];
        for (const folder of getAllFolders(app)) {
            options.push(React.createElement("option", { key: folder, value: folder },
                folder,
                " "));
        }
        return options;
    };
    const getEditorModeView = () => {
        return (React.createElement("div", { style: {
                display: 'flex',
                flexDirection: 'column',
            } },
            React.createElement(Divider, { sx: { marginY: '3px' } }),
            React.createElement("div", { style: { display: "flex", flexDirection: 'row', alignItems: 'center' } },
                React.createElement("text", { style: { fontSize: 12, height: 12, verticalAlign: "bottom", width: 60 } }, "Name: "),
                React.createElement("input", { className: 'workflow-input', placeholder: 'Shortcut name here', style: { width: '100%', height: 20, fontSize: 12 }, id: "shortcut-name", value: shortCutName, onChange: handleNodeShortcutNameChange })),
            React.createElement("div", { style: { display: "flex", flexDirection: 'row', alignItems: 'center' } },
                React.createElement("text", { style: { fontSize: 12, height: 12, verticalAlign: "bottom", width: 60 } }, "Type: "),
                React.createElement("select", { style: { width: '100%', fontSize: 10, height: 20, marginTop: 3 }, name: "select-type", value: shortCutCommand.type, onChange: handleNodeShortcutTypeChange }, getTypeOptions())),
            React.createElement("div", { style: { display: "flex", flexDirection: 'row', alignItems: 'center' } },
                React.createElement("text", { style: { fontSize: 12, height: 12, verticalAlign: "bottom", width: 60 } }, "File: "),
                React.createElement("select", { value: shortCutCommand.commandFile, style: { width: '100%', fontSize: 10, height: 20, marginTop: 3 }, name: "select-type", onChange: handleNodeShortcutFileChange }, shortCutCommandType == CommandType.SHELL ? getScriptOptions() : getFileOptions())),
            React.createElement("div", { style: { display: "flex", flexDirection: 'row', alignItems: 'center' } },
                React.createElement("text", { style: { fontSize: 12, height: 12, verticalAlign: "bottom", width: 60 } }, "Folder: "),
                React.createElement("select", { value: shortCutCommand.commandFolder, style: { width: '100%', fontSize: 10, height: 20, marginTop: 3 }, name: "select-type", onChange: handleNodeShortcutFolderChange }, getFolderOptions()))));
    };
    // modify the conditions here.
    const getWorkflowModeView = () => {
        if (shortCutCommand.type == CommandType.SHELL && !shortCutCommand.commandFile) {
            return null;
        }
        // Mac且没有macShortCut,直接返回
        if (shortCutCommand.type == CommandType.COPY_FILE && (!shortCutCommand.commandFile || !shortCutCommand.commandFolder)) {
            return null;
        }
        return (React.createElement("div", null,
            React.createElement(Divider, { sx: { marginY: '3px' } }),
            React.createElement("div", { style: {
                    display: 'flex',
                    flexDirection: 'row',
                    alignItems: 'center',
                    justifyContent: 'flex-start',
                    marginBottom: 1,
                    marginTop: 1
                }, onClick: () => { onShortcutClick(); } },
                React.createElement(PlayCircleFilledWhiteIcon, { sx: { width: 16, height: 16, marginRight: 1 } }),
                React.createElement(Typography, { sx: { fontSize: 12 } },
                    nodeShortCutModel.name,
                    " "))));
    };
    const getShortcutView = () => {
        if (editorMode) {
            return getEditorModeView();
        }
        else {
            return getWorkflowModeView();
        }
    };
    return (React.createElement("div", null, getShortcutView()));
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiTm9kZVNob3J0Y3V0LnZpZXcuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJOb2RlU2hvcnRjdXQudmlldy50c3giXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQ0EsT0FBTyxFQUFDLE9BQU8sRUFBRSxVQUFVLEVBQUMsTUFBTSxlQUFlLENBQUM7QUFDbEQsT0FBTyxFQUFDLFFBQVEsRUFBRSxLQUFLLEVBQVcsS0FBSyxFQUFDLE1BQU0sVUFBVSxDQUFDO0FBQ3pELE9BQU8seUJBQXlCLE1BQU0sMkNBQTJDLENBQUM7QUFDbEYsT0FBTyxLQUFLLEtBQUssTUFBTSxPQUFPLENBQUM7QUFDL0IsT0FBTyxFQUFDLFVBQVUsRUFBRSxTQUFTLEVBQUUsUUFBUSxFQUFDLE1BQU0sT0FBTyxDQUFDO0FBQ3RELE9BQU8sRUFBQyxXQUFXLEVBQUMsTUFBTSxXQUFXLENBQUM7QUFDdEMsT0FBTyxFQUFDLFNBQVMsRUFBQyxNQUFNLHFCQUFxQixDQUFDO0FBQzlDLE9BQU8sRUFBQyxnQkFBZ0IsRUFBRSxpQkFBaUIsRUFBQyxNQUFNLDJCQUEyQixDQUFDO0FBQzlFLE9BQU8sRUFBQyxnQkFBZ0IsRUFBQyxNQUFNLDZCQUE2QixDQUFDO0FBQzdELE9BQU8sRUFBQyxhQUFhLEVBQUUsaUJBQWlCLEVBQUMsTUFBTSxxQkFBcUIsQ0FBQztBQVFyRSxNQUFNLENBQUMsT0FBTyxVQUFVLGdCQUFnQixDQUFDLGFBQTRCO0lBRXBFLE1BQU0sbUJBQW1CLEdBQUcsVUFBVSxDQUFDLGdCQUFnQixDQUFDLENBQUE7SUFFeEQsTUFBTSxFQUFDLFVBQVUsRUFBRSxpQkFBaUIsRUFBRSxnQkFBZ0IsRUFBQyxHQUFHLGFBQWEsQ0FBQTtJQUN2RSxNQUFNLGVBQWUsR0FBRyxRQUFRLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQyxpQkFBaUIsQ0FBQyxVQUFVLENBQUMsQ0FBQyxDQUFDLGlCQUFpQixDQUFDLE9BQU8sQ0FBQTtJQUVuRyxNQUFNLENBQUMsWUFBWSxFQUFFLGVBQWUsQ0FB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RUQsTUFBTSxlQUFlLEdBQUcsR0FBRyxFQUFFO1FBQzVCLElBQUksVUFBVSxFQUFFO1lBQ2YsT0FBTyxpQkFBaUIsRUFBRSxDQUFDO1NBQzNCO2FBQU07WUFDTixPQUFPLG1CQUFtQixFQUFFLENBQUM7U0FDN0I7SUFDRixDQUFDLENBQUE7SUFFRCxPQUFPLENBQ04saUNBQ0csZUFBZSxFQUFFLENBQ2QsQ0FDTixDQUFDO0FBQ0gsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7Tm9kZVNob3J0Y3V0fSBmcm9tIFwiLi9Ob2RlLm1vZGVsXCI7XHJcbmltcG9ydCB7RGl2aWRlciwgVHlwb2dyYXBoeX0gZnJvbSBcIkBtdWkvbWF0ZXJpYWxcIjtcclxuaW1wb3J0IHtQbGF0Zm9ybSwgVEZpbGUsIFRGb2xkZXIsIFZhdWx0fSBmcm9tIFwib2JzaWRpYW5cIjtcclxuaW1wb3J0IFBsYXlDaXJjbGVGaWxsZWRXaGl0ZUljb24gZnJvbSBcIkBtdWkvaWNvbnMtbWF0ZXJpYWwvUGxheUNpcmNsZUZpbGxlZFdoaXRlXCI7XHJcbmltcG9ydCAqIGFzIFJlYWN0IGZyb20gXCJyZWFjdFwiO1xyXG5pbXBvcnQge3VzZUNvbnRleHQsIHVzZUVmZmVjdCwgdXNlU3RhdGV9IGZyb20gXCJyZWFjdFwiO1xyXG5pbXBvcnQge0NvbW1hbmRUeXBlfSBmcm9tIFwiLi9Db21tYW5kXCI7XHJcbmltcG9ydCB7VGltZVV0aWxzfSBmcm9tIFwiLi4vdXRpbHMvVGltZS51dGlsc1wiO1xyXG5pbXBvcnQge2dldFZhdWx0QmFzZVBhdGgsIHJlcGxhY2VBbGxTbGFzaGVzfSBmcm9tIFwiLi4vc2V0dGluZ3MvU2V0dGluZ0hlbHBlclwiO1xyXG5pbXBvcnQge1dvcmtQYW5lbENvbnRleHR9IGZyb20gXCIuLi93b3JrcGFuZWwvV29ya1BhbmVsLnZpZXdcIjtcclxuaW1wb3J0IHtnZXRBbGxGb2xkZXJzLCBvcGVuRmlsZUluTmV3TGVhZn0gZnJvbSBcIi4uL3V0aWxzL0ZpbGUudXRpbHNcIjtcclxuXHJcbmV4cG9ydCBpbnRlcmZhY2UgU2hvcnRDdXRQcm9wcyB7XHJcblx0ZWRpdG9yTW9kZT86IGJvb2xlYW4sXHJcblx0bm9kZVNob3J0Q3V0TW9kZWw6IE5vZGVTaG9ydGN1dCxcclxuXHRvblVwZGF0ZVNob3J0Q3V0OiAobm9kZVNob3J0Y3V0OiBOb2RlU2hvcnRjdXQpID0+IHZvaWQsXHJcbn1cclxuXHJcbmV4cG9ydCBkZWZhdWx0IGZ1bmN0aW9uIE5vZGVTaG9ydGN1dFZpZXcobm9kZVZpZXdQcm9wczogU2hvcnRDdXRQcm9wcykge1xyXG5cclxuXHRjb25zdCB3b3JrUGFuZWxDb250cm9sbGVyID0gdXNlQ29udGV4dChXb3JrUGFuZWxDb250ZXh0KVxyXG5cclxuXHRjb25zdCB7ZWRpdG9yTW9kZSwgbm9kZVNob3J0Q3V0TW9kZWwsIG9uVXBkYXRlU2hvcnRDdXR9ID0gbm9kZVZpZXdQcm9wc1xyXG5cdGNvbnN0IHNob3J0Q3V0Q29tbWFuZCA9IFBsYXRmb3JtLmlzTWFjT1MgPyBub2RlU2hvcnRDdXRNb2RlbC5tYWNDb21tYW5kIDogbm9kZVNob3J0Q3V0TW9kZWwuY29tbWFuZFxyXG5cclxuXHRjb25zdCBbc2hvcnRDdXROYW1lLCBzZXRTaG9ydGN1dE5hbWVdID0gdXNlU3RhdGUobm9kZVNob3J0Q3V0TW9kZWwubmFtZSB8fCAnJylcclxuXHRjb25zdCBbc2hvcnRDdXRDb21tYW5kVHlwZSwgc2V0U2hvcnRDdXRDb21tYW5kVHlwZV0gPSB1c2VTdGF0ZShzaG9ydEN1dENvbW1hbmQudHlwZSlcclxuXHJcblx0dXNlRWZmZWN0KCgpID0+IHtcclxuXHRcdHNldFNob3J0Y3V0TmFtZShub2RlU2hvcnRDdXRNb2RlbD8ubmFtZSB8fCAnJylcclxuXHRcdHNldFNob3J0Q3V0Q29tbWFuZFR5cGUoc2hvcnRDdXRDb21tYW5kLnR5cGUpXHJcblx0fSwgW25vZGVTaG9ydEN1dE1vZGVsXSlcclxuXHJcblx0LyoqXHJcblx0ICogaGVyZSBhcmUgdGhlIG9yZGVyIHNlcXVlbmNlIG9uIFdpbmRvd3NcclxuXHQgKiAxLiBzd2l0Y2ggdm9sdW1lIChsaWtlIEQ6KVxyXG5cdCAqIDIuIGNkIHRvIHRoZSBmb2xkZXIgdGhhdCBjb250YWlucyB0aGUgc2NyaXB0XHJcblx0ICogMy4gcnVuIHRoZSBzY3JpcHQgd2l0aCBjb21tYW5kRm9sZGVyIGFzIGFyZ3VtZW50XHJcblx0ICogT25seSAuYmF0IGZpbGUgaXMgc3VwcG9ydGVkXHJcblx0ICovXHJcblx0Y29uc3QgZ2V0V2luZG93c0NvbW1hbmQgPSAoKTogc3RyaW5nID0+IHtcclxuXHRcdGNvbnN0IHZhdWx0UGF0aCA9IGdldFZhdWx0QmFzZVBhdGgoYXBwKVxyXG5cdFx0Y29uc3QgY29tbWFuZFBhdGggPSBgJHt2YXVsdFBhdGh9LyR7c2hvcnRDdXRDb21tYW5kLmNvbW1hbmRGaWxlfWBcclxuXHRcdGNvbnN0IGNvbW1hbmRGb2xkZXJQYXRoID0gcmVwbGFjZUFsbFNsYXNoZXMoY29tbWFuZFBhdGguc3Vic3RyaW5nKDAsIGNvbW1hbmRQYXRoLmxhc3RJbmRleE9mKCcvJykpKVxyXG5cdFx0Y29uc3Qgc2NyaXB0TmFtZSA9IHNob3J0Q3V0Q29tbWFuZC5jb21tYW5kRmlsZS5zdWJzdHJpbmcoc2hvcnRDdXRDb21tYW5kLmNvbW1hbmRGaWxlLmxhc3RJbmRleE9mKCcvJykgKyAxKVxyXG5cdFx0Y29uc3QgY29tbWFuZEZvbGRlciA9IGAke3ZhdWx0UGF0aH0vJHtzaG9ydEN1dENvbW1hbmQuY29tbWFuZEZvbGRlcn1gXHJcblx0XHRjb25zdCBjb21tYW5kRGVzY0ZvbGRlclBhdGggPSByZXBsYWNlQWxsU2xhc2hlcyhjb21tYW5kRm9sZGVyLnN1YnN0cmluZygwLCBjb21tYW5kRm9sZGVyLmxhc3RJbmRleE9mKCcvJykpKVxyXG5cdFx0bGV0IHN3aXRjaFZvbHVtZSA9IHZhdWx0UGF0aC5zdWJzdHJpbmcoMCwgdmF1bHRQYXRoLmxhc3RJbmRleE9mKCc6JykrMSlcclxuXHRcdHJldHVybiBgJHtzd2l0Y2hWb2x1bWV9ICYgY2QgJHtjb21tYW5kRm9sZGVyUGF0aH0gJiAke3NjcmlwdE5hbWV9IFwiJHtjb21tYW5kRGVzY0ZvbGRlclBhdGh9XCJgXHJcblx0fVxyXG5cclxuXHQvKipcclxuXHQgKiB0byBiZSBkZWNpZGVkIG9uIE1hY09TXHJcblx0ICovXHJcblx0Y29uc3QgZ2V0TWFjQ29tbWFuZCA9ICgpOiBzdHJpbmcgPT4ge1xyXG5cdFx0Y29uc3QgdmF1bHRQYXRoID0gZ2V0VmF1bHRCYXNlUGF0aChhcHApXHJcblx0XHRjb25zdCBjb21tYW5kUGF0aCA9IGAke3ZhdWx0UGF0aH0vJHtzaG9ydEN1dENvbW1hbmQuY29tbWFuZEZpbGV9YFxyXG5cdFx0Y29uc3QgY29tbWFuZEZvbGRlciA9IGAke3ZhdWx0UGF0aH0vJHtzaG9ydEN1dENvbW1hbmQuY29tbWFuZEZvbGRlcn1gXHJcblx0XHRyZXR1cm4gYCR7Y29tbWFuZFBhdGh9YFxyXG5cdH1cclxuXHJcblx0Y29uc3QgZ2V0TWFjQ29tbWFuZEZvbGRlciA9ICgpOiBzdHJpbmcgPT4ge1xyXG5cdFx0Y29uc3QgdmF1bHRQYXRoID0gZ2V0VmF1bHRCYXNlUGF0aChhcHApXHJcblx0XHRjb25zdCBjb21tYW5kRm9sZGVyID0gYCR7dmF1bHRQYXRofS8ke3Nob3J0Q3V0Q29tbWFuZC5jb21tYW5kRm9sZGVyfWBcclxuXHRcdHJldHVybiBgXCIke2NvbW1hbmRGb2xkZXJ9XCJgXHJcblxyXG5cdH1cclxuXHJcblx0Ly8gZXhlY3V0ZSB0aGUgc3RvcmVkIGNvbW1hbmRcclxuXHRjb25zdCBvblNob3J0Y3V0Q2xpY2sgPSAoKSA9PiB7XHJcblx0XHRpZiAoIVBsYXRmb3JtLmlzRGVza3RvcCkge1xyXG5cdFx0XHRyZXR1cm47XHJcblx0XHR9XHJcblx0XHQvLyBleGVjdXRlIHRoZSBzaGVsbCBjb21tYW5kIGluIGEgc3ViLXByb2Nlc3MsIGZvbGRlciBpcyBwYXNzZWQgYXMgYW4gYXJndW1lbnRcclxuXHRcdC8vIGNhbmB0IGJlIHVzZWQgYmVjYXVzZSBub3QgZW50ZXIgdGhlIGZvbGRlclxyXG5cdFx0aWYgKHNob3J0Q3V0Q29tbWFuZC50eXBlID09PSBDb21tYW5kVHlwZS5TSEVMTCkge1xyXG5cdFx0XHRpZiAoIXNob3J0Q3V0Q29tbWFuZC5jb21tYW5kRmlsZSkge1xyXG5cdFx0XHRcdHJldHVybjtcclxuXHRcdFx0fVxyXG5cdFx0XHRpZiAoUGxhdGZvcm0uaXNNYWNPUykge1xyXG5cdFx0XHRcdGNvbnNvbGUubG9nKFwiZmlsZSBwYXRoOiBcIiwgZ2V0TWFjQ29tbWFuZCgpKVxyXG5cdFx0XHRcdGNvbnN0IHJlc3VsdCA9IHJlcXVpcmUoJ2NoaWxkX3Byb2Nlc3MnKS5leGVjRmlsZShnZXRNYWNDb21tYW5kKCksIFtnZXRNYWNDb21tYW5kRm9sZGVyKCldKVxyXG5cdFx0XHR9IGVsc2Uge1xyXG5cdFx0XHRcdHJlcXVpcmUoJ2NoaWxkX3Byb2Nlc3MnKS5leGVjKGdldFdpbmRvd3NDb21tYW5kKCksIHsgZW5jb2Rpbmc6ICd1dGYtOCcgfSlcclxuXHRcdFx0fVxyXG5cdFx0fSBlbHNlIGlmIChzaG9ydEN1dENvbW1hbmQudHlwZSA9PT0gQ29tbWFuZFR5cGUuQ09QWV9GSUxFKSB7XHJcblx0XHRcdGlmICghc2hvcnRDdXRDb21tYW5kLmNvbW1hbmRGaWxlIHx8ICFzaG9ydEN1dENvbW1hbmQuY29tbWFuZEZvbGRlcikge1xyXG5cdFx0XHRcdHJldHVybjtcclxuXHRcdFx0fVxyXG5cdFx0XHRjb25zdCBvcmlnaW5hbEZpbGVOYW1lID0gc2hvcnRDdXRDb21tYW5kLmNvbW1hbmRGaWxlLnN1YnN0cmluZyhzaG9ydEN1dENvbW1hbmQuY29tbWFuZEZpbGUubGFzdEluZGV4T2YoJy8nKSArIDEpXHJcblx0XHRcdGNvbnN0IG5ld0ZpbGVQYXRoID0gYCR7c2hvcnRDdXRDb21tYW5kLmNvbW1hbmRGb2xkZXJ9JHtUaW1lVXRpbHMuZ2V0RGF0ZVN0cihEYXRlLm5vdygpKX0tJHtvcmlnaW5hbEZpbGVOYW1lfWBcclxuXHRcdFx0YXBwLnZhdWx0LmFkYXB0ZXIuZXhpc3RzKG5ld0ZpbGVQYXRoKS50aGVuKChleGlzdCkgPT57XHJcblx0XHRcdFx0aWYgKGV4aXN0KSB7XHJcblx0XHRcdFx0XHRvcGVuRmlsZUluTmV3TGVhZihuZXdGaWxlUGF0aCwgYXBwKVxyXG5cdFx0XHRcdH0gZWxzZSB7XHJcblx0XHRcdFx0XHRhcHAudmF1bHQuYWRhcHRlci5jb3B5KHNob3J0Q3V0Q29tbWFuZC5jb21tYW5kRmlsZSwgbmV3RmlsZVBhdGgpLnRoZW4oKCkgPT4ge1xyXG5cdFx0XHRcdFx0XHRvcGVuRmlsZUluTmV3TGVhZihuZXdGaWxlUGF0aCwgYXBwKVxyXG5cdFx0XHRcdFx0fSlcclxuXHRcdFx0XHR9XHJcblx0XHRcdH0pXHJcblx0XHR9IGVsc2UgaWYgKHNob3J0Q3V0Q29tbWFuZC50eXBlID09PSBDb21tYW5kVHlwZS5PUEVOX0ZJTEUpIHtcclxuXHRcdFx0aWYgKCFzaG9ydEN1dENvbW1hbmQuY29tbWFuZEZpbGUpIHtcclxuXHRcdFx0XHRyZXR1cm5cclxuXHRcdFx0fVxyXG5cdFx0XHRvcGVuRmlsZUluTmV3TGVhZihzaG9ydEN1dENvbW1hbmQuY29tbWFuZEZpbGUsIGFwcClcclxuXHRcdH1cclxuXHR9XHJcblxyXG5cdGNvbnN0IGhhbmRsZU5vZGVTaG9ydGN1dE5hbWVDaGFuZ2UgPSAoZXZlbnQ6IFJlYWN0LkNoYW5nZUV2ZW50PEhUTUxJbnB1dEVsZW1lbnQ+KSA9PiB7XHJcblx0XHRzZXRTaG9ydGN1dE5hbWUoZXZlbnQudGFyZ2V0LnZhbHVlKVxyXG5cdFx0bm9kZVNob3J0Q3V0TW9kZWwubmFtZSA9IGV2ZW50LnRhcmdldC52YWx1ZVxyXG5cdFx0b25VcGRhdGVTaG9ydEN1dChub2RlU2hvcnRDdXRNb2RlbClcclxuXHR9XHJcblxyXG5cdGNvbnN0IGhhbmRsZU5vZGVTaG9ydGN1dFR5cGVDaGFuZ2UgPSAoZXZlbnQ6IFJlYWN0LkNoYW5nZUV2ZW50PEhUTUxTZWxlY3RFbGVtZW50PikgPT4ge1xyXG5cdFx0Y29uc3QgY29tbWFuZFR5cGUgPSBldmVudC50YXJnZXQudmFsdWUgYXMgQ29tbWFuZFR5cGVcclxuXHRcdGlmIChjb21tYW5kVHlwZSA9PT0gc2hvcnRDdXRDb21tYW5kLnR5cGUpIHtcclxuXHRcdFx0cmV0dXJuXHJcblx0XHR9XHJcblx0XHRzZXRTaG9ydEN1dENvbW1hbmRUeXBlKGNvbW1hbmRUeXBlKVxyXG5cdFx0c2hvcnRDdXRDb21tYW5kLnR5cGUgPSBjb21tYW5kVHlwZVxyXG5cdFx0b25VcGRhdGVTaG9ydEN1dChub2RlU2hvcnRDdXRNb2RlbClcclxuXHR9XHJcblxyXG5cdGNvbnN0IGhhbmRsZU5vZGVTaG9ydGN1dEZpbGVDaGFuZ2UgPSAoZXZlbnQ6IFJlYWN0LkNoYW5nZUV2ZW50PEhUTUxTZWxlY3RFbGVtZW50PikgPT4ge1xyXG5cdFx0c2hvcnRDdXRDb21tYW5kLmNvbW1hbmRGaWxlID0gZXZlbnQudGFyZ2V0LnZhbHVlXHJcblx0XHRvblVwZGF0ZVNob3J0Q3V0KG5vZGVTaG9ydEN1dE1vZGVsKVxyXG5cdH1cclxuXHJcblx0Y29uc3QgaGFuZGxlTm9kZVNob3J0Y3V0Rm9sZGVyQ2hhbmdlID0gKGV2ZW50OiBSZWFjdC5DaGFuZ2VFdmVudDxIVE1MU2VsZWN0RWxlbWVudD4pID0+IHtcclxuXHRcdHNob3J0Q3V0Q29tbWFuZC5jb21tYW5kRm9sZGVyID0gZXZlbnQudGFyZ2V0LnZhbHVlXHJcblx0XHRvblVwZGF0ZVNob3J0Q3V0KG5vZGVTaG9ydEN1dE1vZGVsKVxyXG5cdH1cclxuXHJcblx0Y29uc3QgZ2V0VHlwZU9wdGlvbnMgPSAoKSA9PiB7XHJcblx0XHRjb25zdCBvcHRpb25zID0gW11cclxuXHRcdG9wdGlvbnMucHVzaCg8b3B0aW9uIHZhbHVlPXtDb21tYW5kVHlwZS5TSEVMTH0+e0NvbW1hbmRUeXBlLlNIRUxMfTwvb3B0aW9uPik7XHJcblx0XHRvcHRpb25zLnB1c2goPG9wdGlvbiB2YWx1ZT17Q29tbWFuZFR5cGUuQ09QWV9GSUxFfT57Q29tbWFuZFR5cGUuQ09QWV9GSUxFfTwvb3B0aW9uPik7XHJcblx0XHRvcHRpb25zLnB1c2goPG9wdGlvbiB2YWx1ZT17Q29tbWFuZFR5cGUuT1BFTl9GSUxFfT57Q29tbWFuZFR5cGUuT1BFTl9GSUxFfTwvb3B0aW9uPilcclxuXHRcdHJldHVybiBvcHRpb25zO1xyXG5cdH1cclxuXHJcblx0dXNlRWZmZWN0KCgpID0+IHtcclxuXHRcdGdldFNjcmlwdE9wdGlvbnMoKVxyXG5cdH0pXHJcblxyXG5cdGNvbnN0IGdldFNjcmlwdE9wdGlvbnMgPSAoKSA9PiB7XHJcblx0XHRjb25zdCBvcHRpb25zOiBKU1guRWxlbWVudFtdID0gW11cclxuXHRcdGNvbnN0IHNldHRpbmdzID0gd29ya1BhbmVsQ29udHJvbGxlci5wbHVnaW4/LnNldHRpbmdzXHJcblx0XHRjb25zdCBzaGVsbEZvbGRlciA9IGFwcC52YXVsdC5nZXRBYnN0cmFjdEZpbGVCeVBhdGgoc2V0dGluZ3M/LnNjcmlwdFBhdGggfHwgJycpIGFzIFRGb2xkZXJcclxuXHRcdFZhdWx0LnJlY3Vyc2VDaGlsZHJlbihzaGVsbEZvbGRlciwgKGYpID0+IHtcclxuXHRcdFx0aWYgKGYgaW5zdGFuY2VvZiBURmlsZSkge1xyXG5cdFx0XHRcdGlmICghUGxhdGZvcm0uaXNNYWNPUyAmJiBmLmV4dGVuc2lvbi50b0xvd2VyQ2FzZSgpICE9PSAnYmF0Jykge1xyXG5cdFx0XHRcdFx0cmV0dXJuXHJcblx0XHRcdFx0fVxyXG5cdFx0XHRcdGlmIChQbGF0Zm9ybS5pc01hY09TICYmIGYuZXh0ZW5zaW9uLnRvTG93ZXJDYXNlKCkgIT09ICdzaCcpIHtcclxuXHRcdFx0XHRcdHJldHVyblxyXG5cdFx0XHRcdH1cclxuXHRcdFx0XHRvcHRpb25zLnB1c2goPG9wdGlvbiB2YWx1ZT17Zi5wYXRofT57Zi5wYXRofTwvb3B0aW9uPik7XHJcblx0XHRcdH1cclxuXHRcdH0pO1xyXG5cdFx0cmV0dXJuIG9wdGlvbnM7XHJcblx0fVxyXG5cclxuXHRjb25zdCBnZXRGaWxlT3B0aW9ucyA9ICgpID0+IHtcclxuXHRcdGNvbnN0IG9wdGlvbnMgPSBbXVxyXG5cdFx0Y29uc3QgZmlsZXMgPSBhcHAudmF1bHQuZ2V0RmlsZXMoKVxyXG5cdFx0Zm9yIChjb25zdCBmaWxlIG9mIGZpbGVzKSB7XHJcblx0XHRcdG9wdGlvbnMucHVzaCg8b3B0aW9uIGtleT17ZmlsZS5wYXRofSB2YWx1ZT17ZmlsZS5wYXRofT57ZmlsZS5wYXRofTwvb3B0aW9uPilcclxuXHRcdH1cclxuXHRcdHJldHVybiBvcHRpb25zO1xyXG5cdH1cclxuXHJcblx0Y29uc3QgZ2V0Rm9sZGVyT3B0aW9ucyA9ICgpID0+IHtcclxuXHRcdGNvbnN0IG9wdGlvbnMgPSBbXVxyXG5cdFx0Zm9yIChjb25zdCBmb2xkZXIgb2YgZ2V0QWxsRm9sZGVycyhhcHApKSB7XHJcblx0XHRcdG9wdGlvbnMucHVzaCg8b3B0aW9uIGtleT17Zm9sZGVyfSB2YWx1ZT17Zm9sZGVyfT57Zm9sZGVyfSA8L29wdGlvbj4pXHJcblx0XHR9XHJcblx0XHRyZXR1cm4gb3B0aW9ucztcclxuXHR9XHJcblxyXG5cdGNvbnN0IGdldEVkaXRvck1vZGVWaWV3ID0gKCkgPT4ge1xyXG5cdFx0cmV0dXJuIChcclxuXHRcdFx0PGRpdiBzdHlsZT17e1xyXG5cdFx0XHRcdGRpc3BsYXk6ICdmbGV4JyxcclxuXHRcdFx0XHRmbGV4RGlyZWN0aW9uOiAnY29sdW1uJyxcclxuXHRcdFx0fX0+XHJcblx0XHRcdFx0PERpdmlkZXIgc3g9e3ttYXJnaW5ZOiAnM3B4J319Lz5cclxuXHRcdFx0XHQ8ZGl2IHN0eWxlPXt7ZGlzcGxheTogXCJmbGV4XCIsIGZsZXhEaXJlY3Rpb246ICdyb3cnLCBhbGlnbkl0ZW1zOiAnY2VudGVyJ319PlxyXG5cdFx0XHRcdFx0PHRleHQgc3R5bGU9e3tmb250U2l6ZTogMTIsIGhlaWdodDogMTIsIHZlcnRpY2FsQWxpZ246IFwiYm90dG9tXCIsIHdpZHRoOiA2MH19Pk5hbWU6IDwvdGV4dD5cclxuXHRcdFx0XHRcdDxpbnB1dCBjbGFzc05hbWU9eyd3b3JrZmxvdy1pbnB1dCd9IHBsYWNlaG9sZGVyPXsnU2hvcnRjdXQgbmFtZSBoZXJlJ30gc3R5bGU9e3t3aWR0aDogJzEwMCUnLCBoZWlnaHQ6IDIwLCBmb250U2l6ZTogMTJ9fSBpZD1cInNob3J0Y3V0LW5hbWVcIiB2YWx1ZT17c2hvcnRDdXROYW1lfSBvbkNoYW5nZT17aGFuZGxlTm9kZVNob3J0Y3V0TmFtZUNoYW5nZX0gLz5cclxuXHRcdFx0XHQ8L2Rpdj5cclxuXHRcdFx0XHQ8ZGl2IHN0eWxlPXt7ZGlzcGxheTogXCJmbGV4XCIsIGZsZXhEaXJlY3Rpb246ICdyb3cnLCBhbGlnbkl0ZW1zOiAnY2VudGVyJ319PlxyXG5cdFx0XHRcdFx0PHRleHQgc3R5bGU9e3tmb250U2l6ZTogMTIsIGhlaWdodDogMTIsIHZlcnRpY2FsQWxpZ246IFwiYm90dG9tXCIsIHdpZHRoOiA2MH19PlR5cGU6IDwvdGV4dD5cclxuXHRcdFx0XHRcdDxzZWxlY3Qgc3R5bGU9e3t3aWR0aDogJzEwMCUnLCBmb250U2l6ZTogMTAsIGhlaWdodDogMjAsIG1hcmdpblRvcDogM319IG5hbWU9XCJzZWxlY3QtdHlwZVwiIHZhbHVlPXtzaG9ydEN1dENvbW1hbmQudHlwZX0gb25DaGFuZ2U9e2hhbmRsZU5vZGVTaG9ydGN1dFR5cGVDaGFuZ2V9PlxyXG5cdFx0XHRcdFx0XHR7Z2V0VHlwZU9wdGlvbnMoKX1cclxuXHRcdFx0XHRcdDwvc2VsZWN0PlxyXG5cdFx0XHRcdDwvZGl2PlxyXG5cdFx0XHRcdDxkaXYgc3R5bGU9e3tkaXNwbGF5OiBcImZsZXhcIiwgZmxleERpcmVjdGlvbjogJ3JvdycsIGFsaWduSXRlbXM6ICdjZW50ZXInfX0+XHJcblx0XHRcdFx0XHQ8dGV4dCBzdHlsZT17e2ZvbnRTaXplOiAxMiwgaGVpZ2h0OiAxMiwgdmVydGljYWxBbGlnbjogXCJib3R0b21cIiwgd2lkdGg6IDYwfX0+RmlsZTogPC90ZXh0PlxyXG5cdFx0XHRcdFx0PHNlbGVjdCB2YWx1ZT17c2hvcnRDdXRDb21tYW5kLmNvbW1hbmRGaWxlfSBzdHlsZT17e3dpZHRoOiAnMTAwJScsIGZvbnRTaXplOiAxMCwgaGVpZ2h0OiAyMCwgbWFyZ2luVG9wOiAzfX0gbmFtZT1cInNlbGVjdC10eXBlXCIgb25DaGFuZ2U9e2hhbmRsZU5vZGVTaG9ydGN1dEZpbGVDaGFuZ2V9PlxyXG5cdFx0XHRcdFx0XHR7c2hvcnRDdXRDb21tYW5kVHlwZSA9PSBDb21tYW5kVHlwZS5TSEVMTCA/IGdldFNjcmlwdE9wdGlvbnMoKSA6IGdldEZpbGVPcHRpb25zKCl9XHJcblx0XHRcdFx0XHQ8L3NlbGVjdD5cclxuXHRcdFx0XHQ8L2Rpdj5cclxuXHRcdFx0XHQ8ZGl2IHN0eWxlPXt7ZGlzcGxheTogXCJmbGV4XCIsIGZsZXhEaXJlY3Rpb246ICdyb3cnLCBhbGlnbkl0ZW1zOiAnY2VudGVyJ319PlxyXG5cdFx0XHRcdFx0PHRleHQgc3R5bGU9e3tmb250U2l6ZTogMTIsIGhlaWdodDogMTIsIHZlcnRpY2FsQWxpZ246IFwiYm90dG9tXCIsIHdpZHRoOiA2MH19PkZvbGRlcjogPC90ZXh0PlxyXG5cdFx0XHRcdFx0PHNlbGVjdCB2YWx1ZT17c2hvcnRDdXRDb21tYW5kLmNvbW1hbmRGb2xkZXJ9IHN0eWxlPXt7d2lkdGg6ICcxMDAlJywgZm9udFNpemU6IDEwLCBoZWlnaHQ6IDIwLCBtYXJnaW5Ub3A6IDN9fSBuYW1lPVwic2VsZWN0LXR5cGVcIiBvbkNoYW5nZT17aGFuZGxlTm9kZVNob3J0Y3V0Rm9sZGVyQ2hhbmdlfT5cclxuXHRcdFx0XHRcdFx0e2dldEZvbGRlck9wdGlvbnMoKX1cclxuXHRcdFx0XHRcdDwvc2VsZWN0PlxyXG5cdFx0XHRcdDwvZGl2PlxyXG5cclxuXHRcdFx0PC9kaXY+XHJcblx0XHQpXHJcblx0fVxyXG5cclxuXHQvLyBtb2RpZnkgdGhlIGNvbmRpdGlvbnMgaGVyZS5cclxuXHRjb25zdCBnZXRXb3JrZmxvd01vZGVWaWV3ID0gKCkgPT4ge1xyXG5cdFx0aWYgKHNob3J0Q3V0Q29tbWFuZC50eXBlID09IENvbW1hbmRUeXBlLlNIRUxMICYmICFzaG9ydEN1dENvbW1hbmQuY29tbWFuZEZpbGUpIHtcclxuXHRcdFx0cmV0dXJuIG51bGxcclxuXHRcdH1cclxuXHRcdC8vIE1hY+S4lOayoeaciW1hY1Nob3J0Q3V0LOebtOaOpei/lOWbnlxyXG5cdFx0aWYgKHNob3J0Q3V0Q29tbWFuZC50eXBlID09IENvbW1hbmRUeXBlLkNPUFlfRklMRSAmJiAoIXNob3J0Q3V0Q29tbWFuZC5jb21tYW5kRmlsZSB8fCAhc2hvcnRDdXRDb21tYW5kLmNvbW1hbmRGb2xkZXIpKSB7XHJcblx0XHRcdHJldHVybiBudWxsXHJcblx0XHR9XHJcblx0XHRyZXR1cm4gKFxyXG5cdFx0XHQ8ZGl2PlxyXG5cdFx0XHRcdDxEaXZpZGVyIHN4PXt7bWFyZ2luWTogJzNweCd9fS8+XHJcblx0XHRcdFx0PGRpdiBzdHlsZT17e1xyXG5cdFx0XHRcdFx0ZGlzcGxheTogJ2ZsZXgnLFxyXG5cdFx0XHRcdFx0ZmxleERpcmVjdGlvbjogJ3JvdycsXHJcblx0XHRcdFx0XHRhbGlnbkl0ZW1zOiAnY2VudGVyJyxcclxuXHRcdFx0XHRcdGp1c3RpZnlDb250ZW50OiAnZmxleC1zdGFydCcsXHJcblx0XHRcdFx0XHRtYXJnaW5Cb3R0b206IDEsXHJcblx0XHRcdFx0XHRtYXJnaW5Ub3A6IDFcclxuXHRcdFx0XHR9fSBvbkNsaWNrPXsoKT0+IHtvblNob3J0Y3V0Q2xpY2soKX19PlxyXG5cdFx0XHRcdFx0PFBsYXlDaXJjbGVGaWxsZWRXaGl0ZUljb24gc3g9e3t3aWR0aDogMTYsIGhlaWdodDogMTYsIG1hcmdpblJpZ2h0OiAxfX0vPlxyXG5cdFx0XHRcdFx0PFR5cG9ncmFwaHkgc3g9e3tmb250U2l6ZTogMTJ9fT57bm9kZVNob3J0Q3V0TW9kZWwubmFtZX0gPC9UeXBvZ3JhcGh5PlxyXG5cdFx0XHRcdDwvZGl2PlxyXG5cdFx0XHQ8L2Rpdj5cclxuXHRcdCk7XHJcblx0fVxyXG5cclxuXHRjb25zdCBnZXRTaG9ydGN1dFZpZXcgPSAoKSA9PiB7XHJcblx0XHRpZiAoZWRpdG9yTW9kZSkge1xyXG5cdFx0XHRyZXR1cm4gZ2V0RWRpdG9yTW9kZVZpZXcoKTtcclxuXHRcdH0gZWxzZSB7XHJcblx0XHRcdHJldHVybiBnZXRXb3JrZmxvd01vZGVWaWV3KCk7XHJcblx0XHR9XHJcblx0fVxyXG5cclxuXHRyZXR1cm4gKFxyXG5cdFx0PGRpdj5cclxuXHRcdFx0eyBnZXRTaG9ydGN1dFZpZXcoKSB9XHJcblx0XHQ8L2Rpdj5cclxuXHQpO1xyXG59XHJcbiJdfQ==